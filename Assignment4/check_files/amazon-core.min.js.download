define(['jquery','ko','mage/url','amazonPaymentConfig','amazonWidgetsLoader','bluebird','jquery/jquery-storageapi'],function($,ko,url,amazonPaymentConfig){'use strict';var clientId=amazonPaymentConfig.getValue('clientId'),amazonDefined=ko.observable(false),amazonLoginError=ko.observable(false),accessToken=ko.observable(null),regions={'us':'NA','de':'EU','uk':'EU','jp':'APAC'},sandboxMode,region;if(typeof amazon==='undefined'){window.onAmazonLoginReady=function(){setClientId(clientId);doLogoutOnFlagCookie();sandboxMode=amazonPaymentConfig.getValue('isSandboxEnabled',false);amazon.Login.setSandboxMode(sandboxMode);region=regions[amazonPaymentConfig.getValue('region')];amazon.Login.setRegion(region);};}else{setClientId(clientId);doLogoutOnFlagCookie();}
window.onAmazonPaymentsReady=function(){$(window).trigger('OffAmazonPayments');};function setClientId(cid){amazon.Login.setClientId(cid);amazonDefined(true);}
function amazonLogout(){$.ajax({url:url.build('amazon/logout'),context:this}).always(function(){if(amazonDefined()){amazon.Login.logout();}else{var logout=amazonDefined.subscribe(function(defined){if(defined){amazon.Login.logout();logout.dispose();}});}});}
function doLogoutOnFlagCookie(){var errorFlagCookie='amz_auth_err',amazonLogoutCookie='amz_auth_logout';$.cookieStorage.isSet(errorFlagCookie)?amazonLogoutThrowError(errorFlagCookie):false;$.cookieStorage.isSet(amazonLogoutCookie)?amazonLogoutThrowError(amazonLogoutCookie):false;}
function amazonLogoutThrowError(cookieToRemove){amazonLogout();document.cookie=cookieToRemove+'=; Path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;';amazonLoginError(true);}
return{verifyAmazonLoggedIn:function(){var defer=$.Deferred(),loginOptions={scope:amazonPaymentConfig.getValue('loginScope'),popup:true,interactive:'never'};amazon.Login.authorize(loginOptions,function(response){if(response.error){defer.reject(response.error);}else{accessToken(response.access_token);defer.resolve(!response.error);}});return defer.promise();},AmazonLogout:amazonLogout,amazonDefined:amazonDefined,accessToken:accessToken,amazonLoginError:amazonLoginError};});